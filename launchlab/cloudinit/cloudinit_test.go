package cloudinit

import (
	"io/ioutil"
	"os"
	"testing"
)

func TestGenerateCloudInitGivesMockedValues(t *testing.T) {
	f, _ := os.Open("mocked_cloud_init.yml")
	content, _ := ioutil.ReadAll(f)

	dc := DockerComposeConfig{
		Base64: "dmVyc2lvbjogJzIuMicKc2VydmljZXM6CiAgZXMwMToKICAgIGltYWdlOiBkb2NrZXIuZWxhc3RpYy5jby9lbGFzdGljc2VhcmNoL2VsYXN0aWNzZWFyY2g6Ny4xMy40CiAgICBjb250YWluZXJfbmFtZTogZXMwMQogICAgZW52aXJvbm1lbnQ6CiAgICAgIC0gbm9kZS5uYW1lPWVzMDEKICAgICAgLSBjbHVzdGVyLm5hbWU9ZXMtZG9ja2VyLWNsdXN0ZXIKICAgICAgLSBkaXNjb3Zlcnkuc2VlZF9ob3N0cz1lczAyLGVzMDMKICAgICAgLSBjbHVzdGVyLmluaXRpYWxfbWFzdGVyX25vZGVzPWVzMDEsZXMwMixlczAzCiAgICAgIC0gYm9vdHN0cmFwLm1lbW9yeV9sb2NrPXRydWUKICAgICAgLSAiRVNfSkFWQV9PUFRTPS1YbXM1MTJtIC1YbXg1MTJtIgogICAgdWxpbWl0czoKICAgICAgbWVtbG9jazoKICAgICAgICBzb2Z0OiAtMQogICAgICAgIGhhcmQ6IC0xCiAgICB2b2x1bWVzOgogICAgICAtIGRhdGEwMTovdXNyL3NoYXJlL2VsYXN0aWNzZWFyY2gvZGF0YQogICAgcG9ydHM6CiAgICAgIC0gOTIwMDo5MjAwCiAgICBuZXR3b3JrczoKICAgICAgLSBlbGFzdGljCiAgZXMwMjoKICAgIGltYWdlOiBkb2NrZXIuZWxhc3RpYy5jby9lbGFzdGljc2VhcmNoL2VsYXN0aWNzZWFyY2g6Ny4xMy40CiAgICBjb250YWluZXJfbmFtZTogZXMwMgogICAgZW52aXJvbm1lbnQ6CiAgICAgIC0gbm9kZS5uYW1lPWVzMDIKICAgICAgLSBjbHVzdGVyLm5hbWU9ZXMtZG9ja2VyLWNsdXN0ZXIKICAgICAgLSBkaXNjb3Zlcnkuc2VlZF9ob3N0cz1lczAxLGVzMDMKICAgICAgLSBjbHVzdGVyLmluaXRpYWxfbWFzdGVyX25vZGVzPWVzMDEsZXMwMixlczAzCiAgICAgIC0gYm9vdHN0cmFwLm1lbW9yeV9sb2NrPXRydWUKICAgICAgLSAiRVNfSkFWQV9PUFRTPS1YbXM1MTJtIC1YbXg1MTJtIgogICAgdWxpbWl0czoKICAgICAgbWVtbG9jazoKICAgICAgICBzb2Z0OiAtMQogICAgICAgIGhhcmQ6IC0xCiAgICB2b2x1bWVzOgogICAgICAtIGRhdGEwMjovdXNyL3NoYXJlL2VsYXN0aWNzZWFyY2gvZGF0YQogICAgbmV0d29ya3M6CiAgICAgIC0gZWxhc3RpYwogIGVzMDM6CiAgICBpbWFnZTogZG9ja2VyLmVsYXN0aWMuY28vZWxhc3RpY3NlYXJjaC9lbGFzdGljc2VhcmNoOjcuMTMuNAogICAgY29udGFpbmVyX25hbWU6IGVzMDMKICAgIGVudmlyb25tZW50OgogICAgICAtIG5vZGUubmFtZT1lczAzCiAgICAgIC0gY2x1c3Rlci5uYW1lPWVzLWRvY2tlci1jbHVzdGVyCiAgICAgIC0gZGlzY292ZXJ5LnNlZWRfaG9zdHM9ZXMwMSxlczAyCiAgICAgIC0gY2x1c3Rlci5pbml0aWFsX21hc3Rlcl9ub2Rlcz1lczAxLGVzMDIsZXMwMwogICAgICAtIGJvb3RzdHJhcC5tZW1vcnlfbG9jaz10cnVlCiAgICAgIC0gIkVTX0pBVkFfT1BUUz0tWG1zNTEybSAtWG14NTEybSIKICAgIHVsaW1pdHM6CiAgICAgIG1lbWxvY2s6CiAgICAgICAgc29mdDogLTEKICAgICAgICBoYXJkOiAtMQogICAgdm9sdW1lczoKICAgICAgLSBkYXRhMDM6L3Vzci9zaGFyZS9lbGFzdGljc2VhcmNoL2RhdGEKICAgIG5ldHdvcmtzOgogICAgICAtIGVsYXN0aWMKCnZvbHVtZXM6CiAgZGF0YTAxOgogICAgZHJpdmVyOiBsb2NhbAogIGRhdGEwMjoKICAgIGRyaXZlcjogbG9jYWwKICBkYXRhMDM6CiAgICBkcml2ZXI6IGxvY2FsCgpuZXR3b3JrczoKICBlbGFzdGljOgogICAgZHJpdmVyOiBicmlkZ2U=",
		Raw:    "",
	}
	want := string(content)
	got := GenerateCloudInit(dc)
	if want != got {
		t.Error("Want : ", want, "Got: ", got)
	}
}

func TestGetFilesAsBase64GivesCorrectBase64(t *testing.T) {
	want := "dmVyc2lvbjogJzIuMicKc2VydmljZXM6CiAgZXMwMToKICAgIGltYWdlOiBkb2NrZXIuZWxhc3RpYy5jby9lbGFzdGljc2VhcmNoL2VsYXN0aWNzZWFyY2g6Ny4xMy40CiAgICBjb250YWluZXJfbmFtZTogZXMwMQogICAgZW52aXJvbm1lbnQ6CiAgICAgIC0gbm9kZS5uYW1lPWVzMDEKICAgICAgLSBjbHVzdGVyLm5hbWU9ZXMtZG9ja2VyLWNsdXN0ZXIKICAgICAgLSBkaXNjb3Zlcnkuc2VlZF9ob3N0cz1lczAyLGVzMDMKICAgICAgLSBjbHVzdGVyLmluaXRpYWxfbWFzdGVyX25vZGVzPWVzMDEsZXMwMixlczAzCiAgICAgIC0gYm9vdHN0cmFwLm1lbW9yeV9sb2NrPXRydWUKICAgICAgLSAiRVNfSkFWQV9PUFRTPS1YbXM1MTJtIC1YbXg1MTJtIgogICAgdWxpbWl0czoKICAgICAgbWVtbG9jazoKICAgICAgICBzb2Z0OiAtMQogICAgICAgIGhhcmQ6IC0xCiAgICB2b2x1bWVzOgogICAgICAtIGRhdGEwMTovdXNyL3NoYXJlL2VsYXN0aWNzZWFyY2gvZGF0YQogICAgcG9ydHM6CiAgICAgIC0gOTIwMDo5MjAwCiAgICBuZXR3b3JrczoKICAgICAgLSBlbGFzdGljCiAgZXMwMjoKICAgIGltYWdlOiBkb2NrZXIuZWxhc3RpYy5jby9lbGFzdGljc2VhcmNoL2VsYXN0aWNzZWFyY2g6Ny4xMy40CiAgICBjb250YWluZXJfbmFtZTogZXMwMgogICAgZW52aXJvbm1lbnQ6CiAgICAgIC0gbm9kZS5uYW1lPWVzMDIKICAgICAgLSBjbHVzdGVyLm5hbWU9ZXMtZG9ja2VyLWNsdXN0ZXIKICAgICAgLSBkaXNjb3Zlcnkuc2VlZF9ob3N0cz1lczAxLGVzMDMKICAgICAgLSBjbHVzdGVyLmluaXRpYWxfbWFzdGVyX25vZGVzPWVzMDEsZXMwMixlczAzCiAgICAgIC0gYm9vdHN0cmFwLm1lbW9yeV9sb2NrPXRydWUKICAgICAgLSAiRVNfSkFWQV9PUFRTPS1YbXM1MTJtIC1YbXg1MTJtIgogICAgdWxpbWl0czoKICAgICAgbWVtbG9jazoKICAgICAgICBzb2Z0OiAtMQogICAgICAgIGhhcmQ6IC0xCiAgICB2b2x1bWVzOgogICAgICAtIGRhdGEwMjovdXNyL3NoYXJlL2VsYXN0aWNzZWFyY2gvZGF0YQogICAgbmV0d29ya3M6CiAgICAgIC0gZWxhc3RpYwogIGVzMDM6CiAgICBpbWFnZTogZG9ja2VyLmVsYXN0aWMuY28vZWxhc3RpY3NlYXJjaC9lbGFzdGljc2VhcmNoOjcuMTMuNAogICAgY29udGFpbmVyX25hbWU6IGVzMDMKICAgIGVudmlyb25tZW50OgogICAgICAtIG5vZGUubmFtZT1lczAzCiAgICAgIC0gY2x1c3Rlci5uYW1lPWVzLWRvY2tlci1jbHVzdGVyCiAgICAgIC0gZGlzY292ZXJ5LnNlZWRfaG9zdHM9ZXMwMSxlczAyCiAgICAgIC0gY2x1c3Rlci5pbml0aWFsX21hc3Rlcl9ub2Rlcz1lczAxLGVzMDIsZXMwMwogICAgICAtIGJvb3RzdHJhcC5tZW1vcnlfbG9jaz10cnVlCiAgICAgIC0gIkVTX0pBVkFfT1BUUz0tWG1zNTEybSAtWG14NTEybSIKICAgIHVsaW1pdHM6CiAgICAgIG1lbWxvY2s6CiAgICAgICAgc29mdDogLTEKICAgICAgICBoYXJkOiAtMQogICAgdm9sdW1lczoKICAgICAgLSBkYXRhMDM6L3Vzci9zaGFyZS9lbGFzdGljc2VhcmNoL2RhdGEKICAgIG5ldHdvcmtzOgogICAgICAtIGVsYXN0aWMKCnZvbHVtZXM6CiAgZGF0YTAxOgogICAgZHJpdmVyOiBsb2NhbAogIGRhdGEwMjoKICAgIGRyaXZlcjogbG9jYWwKICBkYXRhMDM6CiAgICBkcml2ZXI6IGxvY2FsCgpuZXR3b3JrczoKICBlbGFzdGljOgogICAgZHJpdmVyOiBicmlkZ2U="
	got, _ := GetFileAsBase64("examples/elasticsearch.yml")

	if want != got {
		t.Error("Want : ", want, "\nGot: ", got)
	}
}

func TestGetConfiguredUser(t *testing.T) {
	path := "examples/id_rsa.pub"

	want := `users:
  - name: launchlab
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCv60WjxoM39LgPDbiW7ne3gu18q0NIVv0RE6rDLNal1quXZ3nqAlANpl5qmhDQ+GS/sOtygSG4/9aiOA4vXO54k1mHWL2irjuB9XbXr00+44vSd2q/vtXdGXhdSMTf4/XK17fjKSG/9y3yD6nml6q9XgQxx9Vf/IkaKdlK0hbC1ds0+8h83PTb9dF3L7hf3Ch/ghvj5++tWJFdFeG+VI7EDuKNA4zL8C5FdYYWFA88YAmM8ndjA5qCjZXIIeZvZ/z9Kpy6DL0QZ8T3NsxRKapEU3nyiIuEAmn8fbnosWcsovw0IS1Hz6HsjYo4bu/gA82LWt3sdRUBZ/7ZsVD3ELip user@example.com`
	got := GetConfiguredUser(path)
	if want != got {
		t.Error("Want : ", want, "\nGot: ", got)
	}
}
